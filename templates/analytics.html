{% extends "base.html" %}

{% block title %}Analytics - Quick Commerce AI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">
            <i class="fas fa-chart-bar me-3"></i>
            Business Analytics
        </h1>
        <p class="lead text-muted">Advanced insights and performance analysis</p>
    </div>
</div>

<!-- Analytics Controls -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>
                    Analysis Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="analysisDays" class="form-label">Analysis Period (Days)</label>
                        <select class="form-select" id="analysisDays">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="stockThreshold" class="form-label">Stock Alert Threshold (Days)</label>
                        <input type="number" class="form-control" id="stockThreshold" value="7" min="1" max="30">
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="refreshAnalytics()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Refresh Analytics
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Quick Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-danger" id="criticalAlerts">{{ restock_alerts.critical_count if restock_alerts else 0 }}</h4>
                        <small class="text-muted">Critical Alerts</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning" id="underperformingCount">{{ underperforming.underperforming_cities_count if underperforming else 0 }}</h4>
                        <small class="text-muted">Underperforming Cities</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Underperforming Cities Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line-down me-2"></i>
                    Underperforming Cities Analysis
                </h5>
            </div>
            <div class="card-body">
                {% if underperforming and underperforming.underperforming_cities %}
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Analysis Period:</strong> {{ underperforming.analysis_period_days }} days
                        </div>
                        <div class="col-md-3">
                            <strong>Cities Analyzed:</strong> {{ underperforming.total_cities_analyzed }}
                        </div>
                        <div class="col-md-3">
                            <strong>Average Sales:</strong> {{ "%.1f"|format(underperforming.average_units_sold) }} units
                        </div>
                        <div class="col-md-3">
                            <strong>Underperforming:</strong> {{ underperforming.underperforming_cities_count }} cities
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped" id="underperformingTable">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Total Units</th>
                                <th>Total GMV</th>
                                <th>Unique Products</th>
                                <th>Performance vs Avg</th>
                                <th>Recommendation</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for city in underperforming.underperforming_cities[:15] %}
                            <tr>
                                <td><strong>{{ city.city_name }}</strong></td>
                                <td>{{ city.total_units }}</td>
                                <td>â‚¹{{ "%.0f"|format(city.total_gmv) }}</td>
                                <td>{{ city.unique_products }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if city.performance_vs_avg < 25 else 'warning' if city.performance_vs_avg < 50 else 'info' }}">
                                        {{ "%.1f"|format(city.performance_vs_avg) }}%
                                    </span>
                                </td>
                                <td><small>{{ city.recommendation }}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="analyzeCity('{{ city.city_name }}')">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Great! No underperforming cities found. All cities are meeting performance expectations.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Restock Alerts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Restock Alerts
                </h5>
                <span class="badge bg-danger">{{ restock_alerts.critical_count if restock_alerts else 0 }} Critical</span>
            </div>
            <div class="card-body">
                {% if restock_alerts and restock_alerts.restock_alerts %}
                <div class="alert alert-warning mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Total Alerts:</strong> {{ restock_alerts.total_alerts }}
                        </div>
                        <div class="col-md-4">
                            <strong>Critical:</strong> {{ restock_alerts.critical_count }}
                        </div>
                        <div class="col-md-4">
                            <strong>Action Required:</strong> Immediate restocking needed
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped" id="restockTable">
                        <thead>
                            <tr>
                                <th>Product ID</th>
                                <th>City</th>
                                <th>Current Stock</th>
                                <th>Daily Demand</th>
                                <th>Days Remaining</th>
                                <th>Severity</th>
                                <th>Recommended Restock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in restock_alerts.restock_alerts[:20] %}
                            <tr class="{{ 'table-danger' if alert.severity == 'CRITICAL' else 'table-warning' if alert.severity == 'HIGH' else '' }}">
                                <td><span class="badge bg-primary">{{ alert.product_id }}</span></td>
                                <td>{{ alert.city_name }}</td>
                                <td>{{ alert.current_stock }}</td>
                                <td>{{ alert.predicted_daily_demand }}</td>
                                <td>{{ "%.1f"|format(alert.days_remaining) }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if alert.severity == 'CRITICAL' else 'warning' if alert.severity == 'HIGH' else 'info' }}">
                                        {{ alert.severity }}
                                    </span>
                                </td>
                                <td><strong>{{ alert.recommended_restock }}</strong></td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="triggerRestock({{ alert.product_id }}, '{{ alert.city_name }}', {{ alert.recommended_restock }})">
                                        <i class="fas fa-truck"></i> Restock
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-danger" onclick="bulkRestock()">
                        <i class="fas fa-truck-loading me-2"></i>
                        Trigger Bulk Restock for Critical Items
                    </button>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Excellent! No immediate restock alerts. All inventory levels are healthy.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-file-alt me-2"></i>
                            Generate Report
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <button class="btn btn-success w-100" onclick="optimizeInventory()">
                            <i class="fas fa-optimize me-2"></i>
                            Optimize Inventory
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <button class="btn btn-warning w-100" onclick="sendAlerts()">
                            <i class="fas fa-bell me-2"></i>
                            Send Alerts
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <button class="btn btn-info w-100" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>
                            Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshAnalytics() {
    const days = $('#analysisDays').val();
    const threshold = $('#stockThreshold').val();
    
    // Show loading state
    $('button').prop('disabled', true);
    
    // Refresh underperforming cities
    $.get(`/api/underperforming?days=${days}`, function(data) {
        // Update the page with new data (you'd need to implement this)
        console.log('Underperforming data:', data);
    });
    
    // Refresh restock alerts
    $.get(`/api/restock_alerts?days_threshold=${threshold}`, function(data) {
        // Update the page with new data
        console.log('Restock alerts:', data);
        $('#criticalAlerts').text(data.critical_count || 0);
    });
    
    // Re-enable buttons
    setTimeout(() => {
        $('button').prop('disabled', false);
        alert('Analytics refreshed successfully!');
    }, 2000);
}

function analyzeCity(cityName) {
    alert(`Detailed analysis for ${cityName} would open in a new modal/page`);
}

function triggerRestock(productId, cityName, quantity) {
    if (confirm(`Trigger restock of ${quantity} units for product ${productId} in ${cityName}?`)) {
        // Here you would integrate with n8n or your automation system
        alert(`Restock triggered! Warehouse team notified for product ${productId} in ${cityName}`);
    }
}

function bulkRestock() {
    if (confirm('This will trigger restock for all critical items. Continue?')) {
        alert('Bulk restock initiated! All warehouse teams have been notified.');
    }
}

function generateReport() {
    alert('Generating comprehensive analytics report... This would download a PDF/Excel report.');
}

function optimizeInventory() {
    alert('Running inventory optimization algorithm... This would provide optimization recommendations.');
}

function sendAlerts() {
    alert('Sending email/SMS alerts to stakeholders... Notifications sent successfully!');
}

function exportData() {
    alert('Exporting analytics data... This would download data in CSV/Excel format.');
}

// Auto-refresh every 10 minutes
setInterval(function() {
    refreshAnalytics();
}, 600000);
</script>
{% endblock %}